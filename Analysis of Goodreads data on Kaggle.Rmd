---
title: "Analysis of Goodreads data on Kaggle"
output: html_notebook
author:
  - name: Hoang Anh NGO
  - affiliation: Ecole Polytechnique, IP Paris
---

#Loading libraries and understanding the basics of this dataset

##Loading libraries

First, we will load all the necessary libraries for this notebook.

```{r}
library(ggplot2)
library(dplyr)
library("RColorBrewer")
library("viridis")  
library(WVPlots)
```

##Understanding the basic structure of the dataset

We import and investigate the structure of the dataset.

```{r}
goodreads <- read.csv('/Users/ngohoanganh/Desktop/Goodreads Kaggle project/books.csv', stringsAsFactors = FALSE)
str(goodreads)
head(goodreads)
print(paste('The original goodreads book dataset has',nrow(goodreads),'rows and',ncol(goodreads),'columns.'))
```

##Fixing problems of the dataset

First of all, we know that this dataset has 13724 observations with 10 variables. There is one variable that is supposed to be written as "# num_pages". However, as R cannot read special characters in column names, for the sake of convenience, we rename this variable as "num_pages". 

We obverse some problems with this dataset. At columns 4 and 8 (corresponding to variables "average_rating" and "num_page"), we can see that the observations are of type "character", while they should be of type "integer". We fix the problem with the function as.numeric in the following code chunk.

However, while fixing the problem above, those two columns yield some NA values. This can be due to those rows having too many commas, forcing the values that should belong to one columns move to another column. We omit these outliers for a clean dataset by using the function na.omit. 

Moreover, one of the famous authors that we know, J.K Rowling, has a fairly long name of "J.K Rowling-Mary GrandPré". After changing the author's name, we have the dataset available for further analysis.

```{r}
goodreads[goodreads=='J.K. Rowling-Mary GrandPré'] <- 'J.K. Rowling'
head(goodreads)
for(i in c(4,8)) {
  goodreads[,i] <- as.numeric(goodreads[,i])
}
names(goodreads)[names(goodreads) == "X..num_pages"] <- "num_pages"
goodreads <- na.omit(goodreads)
str(goodreads)  
print(paste('The final goodreads book dataset has',nrow(goodreads),'rows and',ncol(goodreads),'columns.'))
```

After fixing all the errors appeared in the dataset, we start to define the variables' names. Their description is as follow:
  - **bookID**: the unique ID for each book/series
  - **title**: the title of each book/series
  - **authors**: the author(s) of the particular book/series
  - **average_rating**: the average ratings of the particular book/series, given by Goodreads' users
  - **ISBN**: old ISBN number of 10 digits, including information about a book/series, for example name, author(s), publisher, genre, etc.
  - **ISBN13**: new ISBN number of 13 digits, introduced in 2007
  - **Language_code**: 3-character language code, which indicates the language in which the book is written
  - **Num_page**: number of pages of each book/series
  - **Ratings_count**: number of ratings given by users for each book/series
  - **Text_reviews_count**: number of text reviews (apart from point reviews of scale 5) given by users for each book/series

```{r}
book_frequency <- data.frame(table(goodreads$title), stringsAsFactors = FALSE)
names(book_frequency) <- c('title','frequency')
book_frequency <- book_frequency[order(-book_frequency$frequency),] 
head(book_frequency)

book_frequency_top20 <- book_frequency[c(1:20),]
ggplot(data=book_frequency_top20, aes(x=reorder(title, frequency),y=frequency, fill = factor(c(1:nrow(book_frequency_top20))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  ggtitle('20 books with highest frequency') + 
  labs(x = "Title", y = "Frequency") 
```

```{r}
book_language <- data.frame(table(goodreads$language_code), stringsAsFactors = FALSE)
names(book_language) <- c('language','frequency')
book_language <- book_language[order(-book_language$frequency),]
book_language$percentage <- round(book_language$frequency/nrow(goodreads)*100, digits = 2)
head(book_language)

ggplot(book_language, aes(x=reorder(language,-frequency),y=frequency, fill = factor(c(1:nrow(book_language))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  ggtitle('Languages written in books/series') + 
  labs(x = "Language", y = "Total number of books") +
  geom_text(aes(label=frequency), vjust=-0.5)
```

```{r}
book_ratings_count <- goodreads[order(-goodreads$ratings_count),]

book_ratings_count_top10 <- book_ratings_count[c(1:10),]
book_ratings_count_top10
ggplot(data=book_ratings_count_top10, aes(x=reorder(title, ratings_count),y=ratings_count, fill = factor(c(1:nrow(book_ratings_count_top10))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Paired") + 
  ggtitle('Books/series with highest number of ratings') + 
  labs(x = "Book/series", y = "Number of ratings") +
  geom_text(
    aes(label = ratings_count), colour = "black",
    hjust = -0.1, size = 2,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

author_most_book_ratings_count <- data.frame(table(book_ratings_count_top10$authors))
names(author_most_book_ratings_count) <- c('author', 'number_of_books')
author_most_book_ratings_count <- author_most_book_ratings_count[order(-author_most_book_ratings_count$number_of_books),]
author_most_book_ratings_count
```

```{r}
book_text_reviews_count <- goodreads[order(-goodreads$text_reviews_count),]

book_text_reviews_count_top10 <- book_text_reviews_count[c(1:10),]
book_text_reviews_count_top10
ggplot(data=book_text_reviews_count_top10, aes(x=reorder(title, text_reviews_count),y=text_reviews_count, fill = factor(c(1:nrow(book_text_reviews_count_top10))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Paired") + 
  ggtitle('Books/series with highest number of text reviews') + 
  labs(x = "Book/series", y = "Number of text reviews") +
  geom_text(
    aes(label = text_reviews_count), colour = "black",
    hjust = -0.1, size = 2,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

author_most_book_text_reviews_count <- data.frame(table(book_text_reviews_count_top10$authors))
names(author_most_book_text_reviews_count) <- c('author', 'number_of_books')
author_most_book_text_reviews_count <- author_most_book_text_reviews_count[order(-author_most_book_text_reviews_count$number_of_books),]
author_most_book_text_reviews_count
```


```{r}
author_most_books <- data.frame(table(goodreads$authors), stringsAsFactors = FALSE)
names(author_most_books) <- c('author','total_number_of_books')
author_most_books <- author_most_books[order(-author_most_books$total_number_of_books),] 
head(author_most_books)

author_most_books_top10 <- author_most_books[c(1:10),]
ggplot(data=author_most_books_top10, aes(x=reorder(author, total_number_of_books),y=total_number_of_books, fill = factor(c(1:nrow(author_most_books_top10))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") + 
  ggtitle('Author with greatest number of books appeared') + 
  labs(x = "Author", y = "Total number of books") +
  geom_text(
    aes(label = total_number_of_books), colour = "black",
    hjust = -0.5, size = 3,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

author_most_books_top10

```

##What are the authors with the greatest number of highly-ranked books?
The definition of "highly-ranked books" in this context is relative. As such, we consider some of the following cases. We define a book to be highly-ranked if its average ranking is greater than:
  - 4.0
  - 4.3
  - 4.5
  

```{r}
author_most_book_high_ratings <- goodreads[goodreads$average_rating >= 4.0,]
author_most_books_high_ratings <- data.frame(table(author_most_book_high_ratings$authors), stringsAsFactors = FALSE)
names(author_most_books_high_ratings) <- c('author','number_of_books_>=_4.0')
author_most_books_high_ratings <- author_most_books_high_ratings[order(-author_most_books_high_ratings$`number_of_books_>=_4.0`),] 

author_most_book_high_ratings_2 <- goodreads[goodreads$average_rating >= 4.3,]
author_most_books_high_ratings_2 <- data.frame(table(author_most_book_high_ratings_2$authors), stringsAsFactors = FALSE)
names(author_most_books_high_ratings_2) <- c('author','number_of_books_>=_4.3')
author_most_books_high_ratings_2 <- author_most_books_high_ratings_2[order(-author_most_books_high_ratings_2$`number_of_books_>=_4.3`),] 

author_most_book_high_ratings_3 <- goodreads[goodreads$average_rating >= 4.5,]
author_most_books_high_ratings_3 <- data.frame(table(author_most_book_high_ratings_3$authors), stringsAsFactors = FALSE)
names(author_most_books_high_ratings_3) <- c('author','number_of_books_>=_4.5')
author_most_books_high_ratings_3 <- author_most_books_high_ratings_3[order(-author_most_books_high_ratings_3$`number_of_books_>=_4.5`),] 

author_most_books_high_ratings_top10 <- author_most_books_high_ratings[c(1:10),]
ggplot(data=author_most_books_high_ratings_top10, aes(x=reorder(author, `number_of_books_>=_4.0`),y=`number_of_books_>=_4.0`, fill = factor(c(1:nrow(author_most_books_high_ratings_top10))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") + 
  ggtitle('Author with greatest number of books ranked >= 4.0') + 
  labs(x = "Author", y = "Total number of highly books ranked >= 4.0") +
  geom_text(
    aes(label = `number_of_books_>=_4.0`), colour = "black",
    hjust = -0.5, size = 3,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

author_most_books_high_ratings_top10_2 <- author_most_books_high_ratings_2[c(1:10),]
ggplot(data=author_most_books_high_ratings_top10_2, aes(x=reorder(author, `number_of_books_>=_4.3`),y=`number_of_books_>=_4.3`, fill = factor(c(1:nrow(author_most_books_high_ratings_top10_2))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") + 
  ggtitle('Author with greatest number of books ranked >= 4.3') + 
  labs(x = "Author", y = "Total number of books ranked >= 4.3") +
  geom_text(
    aes(label = `number_of_books_>=_4.3`), colour = "black",
    hjust = -0.5, size = 3,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

author_most_books_high_ratings_top10_3 <- author_most_books_high_ratings_3[c(1:10),]
ggplot(data=author_most_books_high_ratings_top10_3, aes(x=reorder(author, `number_of_books_>=_4.5`),y=`number_of_books_>=_4.5`, fill = factor(c(1:nrow(author_most_books_high_ratings_top10_3))))) +
  theme(legend.position = "none") + 
  geom_bar(stat="identity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3") + 
  ggtitle('Author with greatest number of books ranked >= 4.5') + 
  labs(x = "Author", y = "Total number of books ranked >= 4.5") +
  geom_text(
    aes(label = `number_of_books_>=_4.5`), colour = "black",
    hjust = -0.5, size = 3,
    position = position_dodge(width = 1),
    inherit.aes = TRUE
  )

x <- Reduce(function(x,y) merge(x,y,by="author",all=TRUE) ,list(author_most_books_high_ratings_top10,author_most_books_high_ratings_top10_2,author_most_books_high_ratings_top10_3))

x
```


```{r}
ggplot(data = goodreads, aes(x = goodreads$average_rating)) + 
    geom_histogram(aes(y = ..density..),binwidth = 0.01, color='orange', fill='orange') +
    geom_density(colour="blue", lwd = 0.5, alpha=0.5) + 
    labs(title="Histogram for books' average ratings", x = "Average ratings", y = "Number of books") + 
    geom_vline(data = goodreads, xintercept = mean(goodreads$average_rating, na.rm = TRUE), color = "red", linetype = "dashed", size = 0.5)


#bảng stats, finish hình thức cho histogram
```

```{r}
ScatterHist(goodreads, "average_rating", "ratings_count", title = "abc", binwidth_x = 0.01, binwidth_y = 100) +
  scale_fill_manual("red") + 
  labs(x = 'Average rating', y = "Number of ratings")
  
```

